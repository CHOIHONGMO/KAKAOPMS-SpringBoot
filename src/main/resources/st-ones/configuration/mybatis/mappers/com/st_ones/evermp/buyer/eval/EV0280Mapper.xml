<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.st_ones.evermp.buyer.eval.EV0280Mapper">

	<select id="srm280_doSearch" resultType="hashmap" parameterType="hashmap">
		SELECT B.EV_NUM
			, B.VENDOR_CD
			, B.VENDOR_NM
			, MAX(B.CREDIT_RATING) AS CREDIT_RATING
			, MAX(B.EVET_EV_ITEM_NUM) AS EV_ITEM_1_NUM
			, MAX(B.EVET_EV_ITEM_SUBJECT) AS EV_ITEM_1_NUM_NM
			, MAX(B.EVET_EV_SCORE) AS EV_SCORE_1_NM
			, MAX(B.EVEE_EV_ITEM_NUM1) AS EV_ITEM_2_NUM
			, MAX(B.EVEE_EV_ITEM_SUBJECT1) AS EV_ITEM_2_NUM_NM
			, CASE WHEN MAX(B.CNT) = 0 THEN 0 ELSE SUM(B.EVEE_EV_ID_SCORE1) / MAX(B.CNT) END AS EV_SCORE_2_NM
			, MAX(B.EVEE_EV_ITEM_NUM2) AS EV_ITEM_3_NUM
			, MAX(B.EVEE_EV_ITEM_SUBJECT2) AS EV_ITEM_3_NUM_NM
			, CASE WHEN MAX(B.CNT) = 0 THEN 0 ELSE SUM(B.EVEE_EV_ID_SCORE2) / MAX(B.CNT) END AS EV_SCORE_3_NM
			, MAX(B.EVET_EV_SCORE) + (CASE WHEN MAX(B.CNT) = 0 THEN 0 ELSE SUM(B.EVEE_EV_ID_SCORE1) / MAX(B.CNT) END) + (CASE WHEN MAX(B.CNT) = 0 THEN 0 ELSE SUM(B.EVEE_EV_ID_SCORE2) / MAX(B.CNT) END) AS EV_SCORE_TOT_NM_BAK
			, MAX(B.EVES_EV_SCORE) AS EV_SCORE_TOT_NM
			, MAX(B.EVES_EV_SCORE) - (MAX(B.EVET_EV_SCORE) + (CASE WHEN MAX(B.CNT) = 0 THEN 0 ELSE SUM(B.EVEE_EV_ID_SCORE1) / MAX(B.CNT) END) + (CASE WHEN MAX(B.CNT) = 0 THEN 0 ELSE SUM(B.EVEE_EV_ID_SCORE2) / MAX(B.CNT) END)) AS AMEND_SCORE
		FROM (
			SELECT A.EV_NUM
				, A.VENDOR_CD
				, A.VENDOR_NM
				, MAX(A.CREDIT_RATING) AS CREDIT_RATING
				, A.EVET_EV_ITEM_NUM
				, MAX(A.EVET_EV_ITEM_SUBJECT) AS EVET_EV_ITEM_SUBJECT
				, MAX(A.EVET_EV_SCORE) AS EVET_EV_SCORE
				, A.EVEE_EV_ITEM_NUM
				, CASE WHEN A.EVEE_EV_ITEM_NUM = 'EVI202011040028' THEN MAX(A.EVEE_EV_ITEM_NUM) ELSE '' END AS EVEE_EV_ITEM_NUM1
				, CASE WHEN A.EVEE_EV_ITEM_NUM = 'EVI202011040029' THEN MAX(A.EVEE_EV_ITEM_NUM) ELSE '' END AS EVEE_EV_ITEM_NUM2
				, CASE WHEN A.EVEE_EV_ITEM_NUM = 'EVI202011040028' THEN MAX(A.EVEE_EV_ITEM_SUBJECT) ELSE '' END AS EVEE_EV_ITEM_SUBJECT1
				, CASE WHEN A.EVEE_EV_ITEM_NUM = 'EVI202011040029' THEN MAX(A.EVEE_EV_ITEM_SUBJECT) ELSE '' END AS EVEE_EV_ITEM_SUBJECT2
				, CASE WHEN A.EVEE_EV_ITEM_NUM = 'EVI202011040028' THEN SUM(A.EVEE_EV_ID_SCORE) ELSE 0 END AS EVEE_EV_ID_SCORE1
				, CASE WHEN A.EVEE_EV_ITEM_NUM = 'EVI202011040029' THEN SUM(A.EVEE_EV_ID_SCORE) ELSE 0 END AS EVEE_EV_ID_SCORE2
				, COUNT(A.EVEE_EV_ITEM_NUM) AS CNT
				, MAX(A.EVES_EV_SCORE) AS EVES_EV_SCORE
			FROM (
				SELECT EVEM.GATE_CD
					, EVEM.EV_NUM
					, EVET.VENDOR_CD
					, VNGL.VENDOR_NM
					, EVET.EV_ITEM_NUM AS EVET_EV_ITEM_NUM
					, EVIM.EV_ITEM_SUBJECT AS EVET_EV_ITEM_SUBJECT
					, EVET.EV_SCORE AS EVET_EV_SCORE
					, VNGL.CREDIT_RATING
					, EVEE.EV_ITEM_NUM AS EVEE_EV_ITEM_NUM
					, EVIM2.EV_ITEM_SUBJECT AS EVEE_EV_ITEM_SUBJECT
					, EVEE.EV_ID_SCORE AS EVEE_EV_ID_SCORE
					, EVES.EV_SCORE AS EVES_EV_SCORE
				FROM STOCEVEM EVEM
				LEFT JOIN STOCEVES EVES
					ON (EVES.GATE_CD = EVEM.GATE_CD
					AND EVES.EV_NUM = EVEM.EV_NUM
					AND EVES.DEL_FLAG = '0')
				LEFT JOIN STOCEVET EVET
					ON (EVET.GATE_CD = EVEM.GATE_CD
					AND EVET.EV_NUM = EVEM.EV_NUM
					AND EVET.EV_TPL_NUM = EVEM.EXEC_EV_TPL_NUM
					AND EVET.VENDOR_CD = EVES.VENDOR_CD
					AND EVET.DEL_FLAG = '0')
				LEFT JOIN STOCVNGL VNGL
					ON (VNGL.GATE_CD = EVET.GATE_CD
					AND VNGL.VENDOR_CD = EVET.VENDOR_CD)
				LEFT JOIN STOCEVIM EVIM
					ON (EVIM.GATE_CD = EVEM.GATE_CD
					AND EVIM.EV_ITEM_NUM = EVET.EV_ITEM_NUM
					AND EVIM.DEL_FLAG = '0')
				LEFT JOIN STOCEVEE EVEE
					ON (EVEE.GATE_CD = EVEM.GATE_CD
					AND EVEE.EV_NUM = EVEM.EV_NUM
					AND EVEE.EV_TPL_NUM = EVEM.EXEC_EV_TPL_NUM
					AND EVEE.VENDOR_CD = EVES.VENDOR_CD
					AND EVEE.VENDOR_SQ = EVES.VENDOR_SQ
					AND EVEE.DEL_FLAG = '0')
				LEFT JOIN STOCVNGL VNGL2
					ON (VNGL2.GATE_CD = EVEE.GATE_CD
					AND VNGL2.VENDOR_CD = EVEE.VENDOR_CD)
				LEFT JOIN STOCEVIM EVIM2
					ON (EVIM2.GATE_CD = EVEE.GATE_CD
					AND EVIM2.EV_ITEM_NUM = EVEE.EV_ITEM_NUM
					AND EVIM2.DEL_FLAG = '0')
				WHERE EVEM.GATE_CD = #{ses.gateCd}
				AND EVEM.DEL_FLAG = '0'
				AND EVEM.PROGRESS_CD = '300'
				AND EVEM.EV_NUM = #{EV_NUM}
			) A
			GROUP BY A.EV_NUM, A.VENDOR_CD, A.VENDOR_NM, A.EVET_EV_ITEM_NUM, A.EVEE_EV_ITEM_NUM
		) B
		GROUP BY B.EV_NUM, B.VENDOR_CD, B.VENDOR_NM
	</select>

</mapper>