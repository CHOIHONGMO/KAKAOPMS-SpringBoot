<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.st_ones.evermp.buyer.eval.EV0290Mapper">

	<select id="srm290_doSearch" resultType="hashmap" parameterType="hashmap">
		select *
		from (
				SELECT EVEM.EV_NUM
					, EVEU.VENDOR_CD
					, EVEU.VENDOR_SQ
					, VNGL.VENDOR_NM
					, 'STONES' + EVEU.EV_USER_ID AS EV_USER_ID
					, MAX(EVEU.EV_SCORE) AS EV_SCORE
					, MAX(XX.VENDOR_EV_SCORE) AS VENDOR_EV_SCORE
					, MAX(XX.AMEND_SCORE) AS AMEND_SCORE
					, MAX(EVES.CONT_DESC) AS CONT_DESC
				FROM STOCEVEM EVEM
				LEFT JOIN STOCEVET EVET
					ON (EVET.GATE_CD = EVEM.GATE_CD
					AND EVET.EV_NUM = EVEM.EV_NUM
					AND EVET.EV_TPL_NUM = EVEM.EXEC_EV_TPL_NUM
					AND EVET.DEL_FLAG = '0')
				LEFT JOIN STOCEVIM EVIM
					ON (EVIM.GATE_CD = EVEM.GATE_CD
					AND EVIM.EV_ITEM_NUM = EVET.EV_ITEM_NUM
					AND EVIM.DEL_FLAG = '0')
				LEFT JOIN STOCEVES EVES
					ON (EVES.GATE_CD = EVEM.GATE_CD
					AND EVES.EV_NUM = EVEM.EV_NUM
					AND EVES.DEL_FLAG = '0')
				LEFT JOIN STOCEVEU EVEU
					ON (EVEU.GATE_CD = EVES.GATE_CD
					AND EVEU.EV_NUM = EVES.EV_NUM
					AND EVEU.VENDOR_CD = EVES.VENDOR_CD
					AND EVEU.VENDOR_SQ = EVES.VENDOR_SQ
					AND EVEU.DEL_FLAG = '0')
				LEFT JOIN STOCVNGL VNGL
					ON (VNGL.GATE_CD = EVEU.GATE_CD
					AND VNGL.VENDOR_CD = EVEU.VENDOR_CD)
				LEFT JOIN STOCUSER CUSER
					ON (CUSER.GATE_CD = EVEU.GATE_CD
					AND CUSER.USER_ID = EVEU.EV_USER_ID)
				LEFT JOIN (
							SELECT B.EV_NUM
								, B.VENDOR_CD
								, B.VENDOR_SQ
								, B.VENDOR_NM
								, MAX(B.EVET_EV_SCORE) + (SUM(B.EVEE_EV_ID_SCORE1) / MAX(B.CNT)) + (SUM(B.EVEE_EV_ID_SCORE2) / MAX(B.CNT)) AS VENDOR_EV_SCORE_BAK
								, MAX(B.EVES_EV_SCORE) AS VENDOR_EV_SCORE
								, MAX(B.EVES_EV_SCORE) - (MAX(B.EVET_EV_SCORE) + (SUM(B.EVEE_EV_ID_SCORE1) / MAX(B.CNT)) + (SUM(B.EVEE_EV_ID_SCORE2) / MAX(B.CNT))) AS AMEND_SCORE
							FROM (
								SELECT A.EV_NUM
									, A.VENDOR_CD
									, A.VENDOR_SQ
									, A.VENDOR_NM
									, MAX(A.CREDIT_RATING) AS CREDIT_RATING
									, A.EVET_EV_ITEM_NUM
									, MAX(A.EVET_EV_ITEM_SUBJECT) AS EVET_EV_ITEM_SUBJECT
									, MAX(A.EVET_EV_SCORE) AS EVET_EV_SCORE
									, A.EVEE_EV_ITEM_NUM
									, CASE WHEN A.EVEE_EV_ITEM_NUM = 'EVI202011040028' THEN MAX(A.EVEE_EV_ITEM_NUM) ELSE '' END AS EVEE_EV_ITEM_NUM1
									, CASE WHEN A.EVEE_EV_ITEM_NUM = 'EVI202011040029' THEN MAX(A.EVEE_EV_ITEM_NUM) ELSE '' END AS EVEE_EV_ITEM_NUM2
									, CASE WHEN A.EVEE_EV_ITEM_NUM = 'EVI202011040028' THEN MAX(A.EVEE_EV_ITEM_SUBJECT) ELSE '' END AS EVEE_EV_ITEM_SUBJECT1
									, CASE WHEN A.EVEE_EV_ITEM_NUM = 'EVI202011040029' THEN MAX(A.EVEE_EV_ITEM_SUBJECT) ELSE '' END AS EVEE_EV_ITEM_SUBJECT2
									, CASE WHEN A.EVEE_EV_ITEM_NUM = 'EVI202011040028' THEN SUM(A.EVEE_EV_ID_SCORE) ELSE 0 END AS EVEE_EV_ID_SCORE1
									, CASE WHEN A.EVEE_EV_ITEM_NUM = 'EVI202011040029' THEN SUM(A.EVEE_EV_ID_SCORE) ELSE 0 END AS EVEE_EV_ID_SCORE2
									, COUNT(A.EVEE_EV_ITEM_NUM) AS CNT
									, MAX(A.EVES_EV_SCORE) AS EVES_EV_SCORE
								FROM (
										SELECT EVEM.GATE_CD
											, EVEM.EV_NUM
											, EVEE.VENDOR_CD
											, EVEE.VENDOR_SQ
											, VNGL2.VENDOR_NM
											, EVET.EV_ITEM_NUM AS EVET_EV_ITEM_NUM
											, EVIM.EV_ITEM_SUBJECT AS EVET_EV_ITEM_SUBJECT
											, EVET.EV_SCORE AS EVET_EV_SCORE
											, VNGL.CREDIT_RATING
											, EVEE.EV_ITEM_NUM AS EVEE_EV_ITEM_NUM
											, EVIM2.EV_ITEM_SUBJECT AS EVEE_EV_ITEM_SUBJECT
											, EVEE.EV_ID_SCORE AS EVEE_EV_ID_SCORE
											, EVES.EV_SCORE AS EVES_EV_SCORE
										FROM STOCEVEM EVEM
										LEFT JOIN STOCEVET EVET
											ON (EVET.GATE_CD = EVEM.GATE_CD
											AND EVET.EV_NUM = EVEM.EV_NUM
											AND EVET.EV_TPL_NUM = EVEM.EXEC_EV_TPL_NUM
											AND EVET.DEL_FLAG = '0')
										LEFT JOIN STOCVNGL VNGL
											ON (VNGL.GATE_CD = EVET.GATE_CD
											AND VNGL.VENDOR_CD = EVET.VENDOR_CD)
										LEFT JOIN STOCEVIM EVIM
											ON (EVIM.GATE_CD = EVEM.GATE_CD
											AND EVIM.EV_ITEM_NUM = EVET.EV_ITEM_NUM
											AND EVIM.DEL_FLAG = '0')
										LEFT JOIN STOCEVEE EVEE
											ON (EVEE.GATE_CD = EVEM.GATE_CD
											AND EVEE.EV_NUM = EVEM.EV_NUM
											AND EVEE.EV_TPL_NUM = EVEM.EXEC_EV_TPL_NUM
											AND EVEE.DEL_FLAG = '0')
										LEFT JOIN STOCVNGL VNGL2
											ON (VNGL2.GATE_CD = EVEE.GATE_CD
											AND VNGL2.VENDOR_CD = EVEE.VENDOR_CD)
										LEFT JOIN STOCEVIM EVIM2
											ON (EVIM2.GATE_CD = EVEE.GATE_CD
											AND EVIM2.EV_ITEM_NUM = EVEE.EV_ITEM_NUM
											AND EVIM2.DEL_FLAG = '0')
										LEFT JOIN STOCEVES EVES
											ON (EVES.GATE_CD = EVEM.GATE_CD
											AND EVES.EV_NUM = EVEM.EV_NUM
											AND EVES.VENDOR_CD = EVEE.VENDOR_CD
											AND EVES.VENDOR_SQ = EVEE.VENDOR_SQ
											AND EVES.DEL_FLAG = '0')
										WHERE EVEM.GATE_CD = #{ses.gateCd}
										AND EVEM.DEL_FLAG = '0'
										AND EVEM.PROGRESS_CD = '300'
										AND EVEM.EV_NUM = (	SELECT TOP 1 S.EV_NUM
															FROM STOCEVEM S
															JOIN STOCEVTM EVTM
																ON (EVTM.GATE_CD = S.GATE_CD
																AND EVTM.EV_TPL_NUM = S.EXEC_EV_TPL_NUM
																AND EVTM.PERIODIC_EV_TYPE = 'CO')
															WHERE S.GATE_CD = #{ses.gateCd}
															AND S.DEL_FLAG = '0'
															AND (	SELECT SS.CLOSE_DATE
                                                            		FROM STOCEVEM SS
                                                                    WHERE SS.GATE_CD = #{ses.gateCd}
                                                                    AND SS.DEL_FLAG = '0'
                                                                    AND SS.EV_NUM = #{EV_NUM}
                                                            	) >= S.CLOSE_DATE
															ORDER BY S.CLOSE_DATE DESC, S.EV_NUM DESC
															)
										) A
								GROUP BY A.EV_NUM, A.VENDOR_CD, A.VENDOR_SQ, A.VENDOR_NM, A.EVET_EV_ITEM_NUM, A.EVEE_EV_ITEM_NUM
								) B
							GROUP BY B.EV_NUM, B.VENDOR_CD, B.VENDOR_SQ, B.VENDOR_NM
							) XX
					ON (XX.VENDOR_CD = VNGL.VENDOR_CD)
				WHERE EVEM.GATE_CD = #{ses.gateCd}
				AND EVEM.DEL_FLAG = '0'
				AND EVEM.PROGRESS_CD = '300'
				AND EVEM.EV_NUM = #{EV_NUM}
				GROUP BY EVEM.EV_NUM, EVEU.VENDOR_CD, EVEU.VENDOR_SQ, VNGL.VENDOR_NM, EVEU.EV_USER_ID
		) A
		PIVOT (SUM(EV_SCORE) FOR EV_USER_ID IN
			<foreach collection="EV_USER_ID_LIST" item="userId" open="(" close=")" separator=",">${userId}</foreach>) AS PVT
	</select>

	<select id="srm290_doSearch_USER_ID" resultType="String" parameterType="hashmap">
			<if test="_databaseId == 'mssql'">
		SELECT <include refid="com.sql.nvl"/>(STUFF((
				SELECT ',STONES' + EVEU.EV_USER_ID
				FROM STOCEVEM EVEM
				LEFT JOIN STOCEVET EVET
					ON (EVET.GATE_CD = EVEM.GATE_CD
					AND EVET.EV_NUM = EVEM.EV_NUM
					AND EVET.EV_TPL_NUM = EVEM.EXEC_EV_TPL_NUM
					AND EVET.DEL_FLAG = '0')
				LEFT JOIN STOCEVIM EVIM
					ON (EVIM.GATE_CD = EVEM.GATE_CD
					AND EVIM.EV_ITEM_NUM = EVET.EV_ITEM_NUM
					AND EVIM.DEL_FLAG = '0')
				LEFT JOIN STOCEVEU EVEU
					ON (EVEU.GATE_CD = EVEM.GATE_CD
					AND EVEU.EV_NUM = EVEM.EV_NUM
					AND EVEU.DEL_FLAG = '0')
				LEFT JOIN STOCVNGL VNGL
					ON (VNGL.GATE_CD = EVEU.GATE_CD
					AND VNGL.VENDOR_CD = EVEU.VENDOR_CD)
				LEFT JOIN STOCUSER CUSER
					ON (CUSER.GATE_CD = EVEU.GATE_CD
					AND CUSER.USER_ID = EVEU.EV_USER_ID)
				WHERE EVEM.GATE_CD = #{ses.gateCd}
				AND EVEM.DEL_FLAG = '0'
				AND EVEM.PROGRESS_CD = '300'
				AND EVEM.EV_NUM = #{EV_NUM}
				GROUP BY EVEU.EV_USER_ID
				ORDER BY EVEU.EV_USER_ID
				FOR XML PATH('')), 1, 1, ''), '')
			</if>
			<if test="_databaseId == 'oracle'">
		SELECT <include refid="com.sql.nvl"/>((
				SELECT LISTAGG(EVEU.EV_USER_ID, ',STONES')
				FROM STOCEVEM EVEM
				LEFT JOIN STOCEVET EVET
					ON (EVET.GATE_CD = EVEM.GATE_CD
					AND EVET.EV_NUM = EVEM.EV_NUM
					AND EVET.EV_TPL_NUM = EVEM.EXEC_EV_TPL_NUM
					AND EVET.DEL_FLAG = '0')
				LEFT JOIN STOCEVIM EVIM
					ON (EVIM.GATE_CD = EVEM.GATE_CD
					AND EVIM.EV_ITEM_NUM = EVET.EV_ITEM_NUM
					AND EVIM.DEL_FLAG = '0')
				LEFT JOIN STOCEVEU EVEU
					ON (EVEU.GATE_CD = EVEM.GATE_CD
					AND EVEU.EV_NUM = EVEM.EV_NUM
					AND EVEU.DEL_FLAG = '0')
				LEFT JOIN STOCVNGL VNGL
					ON (VNGL.GATE_CD = EVEU.GATE_CD
					AND VNGL.VENDOR_CD = EVEU.VENDOR_CD)
				LEFT JOIN STOCUSER CUSER
					ON (CUSER.GATE_CD = EVEU.GATE_CD
					AND CUSER.USER_ID = EVEU.EV_USER_ID)
				WHERE EVEM.GATE_CD = #{ses.gateCd}
				AND EVEM.DEL_FLAG = '0'
				AND EVEM.PROGRESS_CD = '300'
				AND EVEM.EV_NUM = #{EV_NUM}
				GROUP BY EVEU.EV_USER_ID
				ORDER BY EVEU.EV_USER_ID
				), '')
			 FROM DUAL
			</if>
	</select>

		<select id="srm290_doSearch_USER_NM" resultType="hashmap" parameterType="hashmap">
				SELECT EVEU.EV_USER_ID
					, MAX(CUSER.USER_NM) AS EV_USER_NM
				FROM STOCEVEM EVEM
				LEFT JOIN STOCEVET EVET
					ON (EVET.GATE_CD = EVEM.GATE_CD
					AND EVET.EV_NUM = EVEM.EV_NUM
					AND EVET.EV_TPL_NUM = EVEM.EXEC_EV_TPL_NUM
					AND EVET.DEL_FLAG = '0')
				LEFT JOIN STOCEVIM EVIM
					ON (EVIM.GATE_CD = EVEM.GATE_CD
					AND EVIM.EV_ITEM_NUM = EVET.EV_ITEM_NUM
					AND EVIM.DEL_FLAG = '0')
				LEFT JOIN STOCEVEU EVEU
					ON (EVEU.GATE_CD = EVEM.GATE_CD
					AND EVEU.EV_NUM = EVEM.EV_NUM
					AND EVEU.DEL_FLAG = '0')
				LEFT JOIN STOCVNGL VNGL
					ON (VNGL.GATE_CD = EVEU.GATE_CD
					AND VNGL.VENDOR_CD = EVEU.VENDOR_CD)
				LEFT JOIN STOCUSER CUSER
					ON (CUSER.GATE_CD = EVEU.GATE_CD
					AND CUSER.USER_ID = EVEU.EV_USER_ID)
				WHERE EVEM.GATE_CD = #{ses.gateCd}
				AND EVEM.DEL_FLAG = '0'
				AND EVEM.PROGRESS_CD = '300'
				AND EVEM.EV_NUM = #{EV_NUM}
				GROUP BY EVEU.EV_USER_ID
				ORDER BY EVEU.EV_USER_ID
	</select>
</mapper>